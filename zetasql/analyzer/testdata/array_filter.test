[default enabled_ast_rewrites=DEFAULTS]

[default language_features=V_1_3_INLINE_LAMBDA_ARGUMENT,V_1_3_WITH_RECURSIVE]
SELECT ARRAY_FILTER([1,2,3], e -> e>0);
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#1]
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#1)
    |               +-Literal(type=INT64, value=0)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#6]
    |         +-expr_list=
    |         | +-$col1#6 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#3)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#3)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#4]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#4, $array_offset.off#5]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#4, $array_offset.off#5]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#3, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#4
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#5)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#4)
    |         |           |       +-Literal(type=INT64, value=0)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#5)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#3]
    |             +-expr_list=
    |             | +-array_input#3 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# Mixing ARRAY_FILTER with other functions
SELECT ARRAY_REVERSE(ARRAY_FILTER([1,2,3], e -> e>0));
--
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(ZetaSQL:array_reverse(ARRAY<INT64>) -> ARRAY<INT64>)
    |     +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |       +-FunctionArgument
    |       | +-expr=
    |       |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |       +-FunctionArgument
    |         +-inline_lambda=
    |           +-InlineLambda
    |             +-argument_list=[$lambda_arg.e#1]
    |             +-body=
    |               +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |                 +-ColumnRef(type=INT64, column=$lambda_arg.e#1)
    |                 +-Literal(type=INT64, value=0)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#2 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#2]
    +-expr_list=
    | +-$col1#2 :=
    |   +-FunctionCall(ZetaSQL:array_reverse(ARRAY<INT64>) -> ARRAY<INT64>)
    |     +-SubqueryExpr
    |       +-type=ARRAY<INT64>
    |       +-subquery_type=SCALAR
    |       +-subquery=
    |         +-ProjectScan
    |           +-column_list=[$expr_subquery.$col1#6]
    |           +-expr_list=
    |           | +-$col1#6 :=
    |           |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |           |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |           |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#3)
    |           |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |           |     +-SubqueryExpr
    |           |       +-type=ARRAY<INT64>
    |           |       +-subquery_type=ARRAY
    |           |       +-parameter_list=
    |           |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#3)
    |           |       +-subquery=
    |           |         +-OrderByScan
    |           |           +-column_list=[$array.element#4]
    |           |           +-is_ordered=TRUE
    |           |           +-input_scan=
    |           |           | +-FilterScan
    |           |           |   +-column_list=[$array.element#4, $array_offset.off#5]
    |           |           |   +-input_scan=
    |           |           |   | +-ArrayScan
    |           |           |   |   +-column_list=[$array.element#4, $array_offset.off#5]
    |           |           |   |   +-array_expr=
    |           |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#3, is_correlated=TRUE)
    |           |           |   |   +-element_column=$array.element#4
    |           |           |   |   +-array_offset_column=
    |           |           |   |     +-ColumnHolder(column=$array_offset.off#5)
    |           |           |   +-filter_expr=
    |           |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |           |           |       +-ColumnRef(type=INT64, column=$array.element#4)
    |           |           |       +-Literal(type=INT64, value=0)
    |           |           +-order_by_item_list=
    |           |             +-OrderByItem
    |           |               +-column_ref=
    |           |                 +-ColumnRef(type=INT64, column=$array_offset.off#5)
    |           +-input_scan=
    |             +-ProjectScan
    |               +-column_list=[$subquery1.array_input#3]
    |               +-expr_list=
    |               | +-array_input#3 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |               +-input_scan=
    |                 +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# ARRAY_FILTER with offset
SELECT ARRAY_FILTER([1,2,3], (e, i) -> e>i);
--
QueryStmt
+-output_column_list=
| +-$query.$col1#3 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#3]
    +-expr_list=
    | +-$col1#3 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA((INT64, INT64)->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=$lambda_arg.[e#1, i#2]
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#1)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.i#2)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#3 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#3]
    +-expr_list=
    | +-$col1#3 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#7]
    |         +-expr_list=
    |         | +-$col1#7 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#5]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#5, $array_offset.off#6]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#5, $array_offset.off#6]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#5
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#6)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#5)
    |         |           |       +-ColumnRef(type=INT64, column=$array_offset.off#6)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#6)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#4]
    |             +-expr_list=
    |             | +-array_input#4 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# Lambda body referencing columns
SELECT ARRAY_FILTER([1,2,3], e -> e > Key) FROM KeyValue;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#4 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#4]
    +-expr_list=
    | +-$col1#4 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#3]
    |           +-parameter_list=
    |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |               +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0])

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#4 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#4]
    +-expr_list=
    | +-$col1#4 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#8]
    |         +-expr_list=
    |         | +-$col1#8 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5)
    |         |       | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#6]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#6, $array_offset.off#7]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#6, $array_offset.off#7]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#6
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#7)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#6)
    |         |           |       +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#7)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#5]
    |             +-expr_list=
    |             | +-array_input#5 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0])
==

# Lambda body referencing columns with offset.
SELECT ARRAY_FILTER([1,2,3], (e,i) -> (e+i) > Key) FROM KeyValue;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA((INT64, INT64)->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=$lambda_arg.[e#3, i#4]
    |           +-parameter_list=
    |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |               | +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |               | +-ColumnRef(type=INT64, column=$lambda_arg.i#4)
    |               +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0])

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#9]
    |         +-expr_list=
    |         | +-$col1#9 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |       | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#7]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#7
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#8)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |         |           |       | +-ColumnRef(type=INT64, column=$array.element#7)
    |         |           |       | +-ColumnRef(type=INT64, column=$array_offset.off#8)
    |         |           |       +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#8)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#6]
    |             +-expr_list=
    |             | +-array_input#6 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0])
==

# Correlated reference in array input expression.
SELECT ARRAY_FILTER([1,Key], e-> e>0) FROM KeyValue;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#4 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#4]
    +-expr_list=
    | +-$col1#4 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(ZetaSQL:$make_array(repeated(2) INT64) -> ARRAY<INT64>)
    |     |     +-Literal(type=INT64, value=1)
    |     |     +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#3]
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |               +-Literal(type=INT64, value=0)
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0])

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#4 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#4]
    +-expr_list=
    | +-$col1#4 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#8]
    |         +-expr_list=
    |         | +-$col1#8 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#6]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#6, $array_offset.off#7]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#6, $array_offset.off#7]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#6
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#7)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#6)
    |         |           |       +-Literal(type=INT64, value=0)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#7)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#5]
    |             +-expr_list=
    |             | +-array_input#5 :=
    |             |   +-FunctionCall(ZetaSQL:$make_array(repeated(2) INT64) -> ARRAY<INT64>)
    |             |     +-Literal(type=INT64, value=1)
    |             |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0])
==

# Lambda argument shadowing KeyValue.Key.
SELECT ARRAY_FILTER([1,2, Key], Key-> Key>kv.Key) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#4 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#4]
    +-expr_list=
    | +-$col1#4 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |     |     +-Literal(type=INT64, value=1)
    |     |     +-Literal(type=INT64, value=2)
    |     |     +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.Key#3]
    |           +-parameter_list=
    |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.Key#3)
    |               +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#4 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#4]
    +-expr_list=
    | +-$col1#4 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#8]
    |         +-expr_list=
    |         | +-$col1#8 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5)
    |         |       | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#6]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#6, $array_offset.off#7]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#6, $array_offset.off#7]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#5, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#6
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#7)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#6)
    |         |           |       +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#7)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#5]
    |             +-expr_list=
    |             | +-array_input#5 :=
    |             |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |             |     +-Literal(type=INT64, value=1)
    |             |     +-Literal(type=INT64, value=2)
    |             |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# Array input has ARRAY_FILTER and column ref.
SELECT ARRAY_FILTER(ARRAY_FILTER([1,2,Key], e->e>0), e->e>1) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     |     +-FunctionArgument
    |     |     | +-expr=
    |     |     |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |     |     |     +-Literal(type=INT64, value=1)
    |     |     |     +-Literal(type=INT64, value=2)
    |     |     |     +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     |     +-FunctionArgument
    |     |       +-inline_lambda=
    |     |         +-InlineLambda
    |     |           +-argument_list=[$lambda_arg.e#3]
    |     |           +-body=
    |     |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |     |               +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |     |               +-Literal(type=INT64, value=0)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#4]
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#4)
    |               +-Literal(type=INT64, value=1)
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#13]
    |         +-expr_list=
    |         | +-$col1#13 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#10)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#10)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#11]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#11, $array_offset.off#12]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#11, $array_offset.off#12]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#10, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#11
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#12)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#11)
    |         |           |       +-Literal(type=INT64, value=1)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#12)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#10]
    |             +-expr_list=
    |             | +-array_input#10 :=
    |             |   +-SubqueryExpr
    |             |     +-type=ARRAY<INT64>
    |             |     +-subquery_type=SCALAR
    |             |     +-parameter_list=
    |             |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |             |     +-subquery=
    |             |       +-ProjectScan
    |             |         +-column_list=[$expr_subquery.$col1#9]
    |             |         +-expr_list=
    |             |         | +-$col1#9 :=
    |             |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |             |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |             |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |             |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |             |         |     +-SubqueryExpr
    |             |         |       +-type=ARRAY<INT64>
    |             |         |       +-subquery_type=ARRAY
    |             |         |       +-parameter_list=
    |             |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |             |         |       +-subquery=
    |             |         |         +-OrderByScan
    |             |         |           +-column_list=[$array.element#7]
    |             |         |           +-is_ordered=TRUE
    |             |         |           +-input_scan=
    |             |         |           | +-FilterScan
    |             |         |           |   +-column_list=[$array.element#7, $array_offset.off#8]
    |             |         |           |   +-input_scan=
    |             |         |           |   | +-ArrayScan
    |             |         |           |   |   +-column_list=[$array.element#7, $array_offset.off#8]
    |             |         |           |   |   +-array_expr=
    |             |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6, is_correlated=TRUE)
    |             |         |           |   |   +-element_column=$array.element#7
    |             |         |           |   |   +-array_offset_column=
    |             |         |           |   |     +-ColumnHolder(column=$array_offset.off#8)
    |             |         |           |   +-filter_expr=
    |             |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |             |         |           |       +-ColumnRef(type=INT64, column=$array.element#7)
    |             |         |           |       +-Literal(type=INT64, value=0)
    |             |         |           +-order_by_item_list=
    |             |         |             +-OrderByItem
    |             |         |               +-column_ref=
    |             |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#8)
    |             |         +-input_scan=
    |             |           +-ProjectScan
    |             |             +-column_list=[$subquery1.array_input#6]
    |             |             +-expr_list=
    |             |             | +-array_input#6 :=
    |             |             |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |             |             |     +-Literal(type=INT64, value=1)
    |             |             |     +-Literal(type=INT64, value=2)
    |             |             |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |             |             +-input_scan=
    |             |               +-SingleRowScan
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# Array input has ARRAY_FILTER and correlated column ref.
SELECT (SELECT(ARRAY_FILTER(ARRAY_FILTER([1,2,Key], e->e>0), e->e>1))) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#6 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#6]
    +-expr_list=
    | +-$col1#6 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#5]
    |         +-expr_list=
    |         | +-$col1#5 :=
    |         |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |         |     +-FunctionArgument
    |         |     | +-expr=
    |         |     |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |         |     |     +-FunctionArgument
    |         |     |     | +-expr=
    |         |     |     |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |     |     |     +-Literal(type=INT64, value=1)
    |         |     |     |     +-Literal(type=INT64, value=2)
    |         |     |     |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     |     +-FunctionArgument
    |         |     |       +-inline_lambda=
    |         |     |         +-InlineLambda
    |         |     |           +-argument_list=[$lambda_arg.e#3]
    |         |     |           +-body=
    |         |     |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |     |               +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |         |     |               +-Literal(type=INT64, value=0)
    |         |     +-FunctionArgument
    |         |       +-inline_lambda=
    |         |         +-InlineLambda
    |         |           +-argument_list=[$lambda_arg.e#4]
    |         |           +-body=
    |         |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |               +-ColumnRef(type=INT64, column=$lambda_arg.e#4)
    |         |               +-Literal(type=INT64, value=1)
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#6 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#6]
    +-expr_list=
    | +-$col1#6 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#5]
    |         +-expr_list=
    |         | +-$col1#5 :=
    |         |   +-SubqueryExpr
    |         |     +-type=ARRAY<INT64>
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     +-subquery=
    |         |       +-ProjectScan
    |         |         +-column_list=[$expr_subquery.$col1#14]
    |         |         +-expr_list=
    |         |         | +-$col1#14 :=
    |         |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#11)
    |         |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |         |     +-SubqueryExpr
    |         |         |       +-type=ARRAY<INT64>
    |         |         |       +-subquery_type=ARRAY
    |         |         |       +-parameter_list=
    |         |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#11)
    |         |         |       +-subquery=
    |         |         |         +-OrderByScan
    |         |         |           +-column_list=[$array.element#12]
    |         |         |           +-is_ordered=TRUE
    |         |         |           +-input_scan=
    |         |         |           | +-FilterScan
    |         |         |           |   +-column_list=[$array.element#12, $array_offset.off#13]
    |         |         |           |   +-input_scan=
    |         |         |           |   | +-ArrayScan
    |         |         |           |   |   +-column_list=[$array.element#12, $array_offset.off#13]
    |         |         |           |   |   +-array_expr=
    |         |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#11, is_correlated=TRUE)
    |         |         |           |   |   +-element_column=$array.element#12
    |         |         |           |   |   +-array_offset_column=
    |         |         |           |   |     +-ColumnHolder(column=$array_offset.off#13)
    |         |         |           |   +-filter_expr=
    |         |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |         |           |       +-ColumnRef(type=INT64, column=$array.element#12)
    |         |         |           |       +-Literal(type=INT64, value=1)
    |         |         |           +-order_by_item_list=
    |         |         |             +-OrderByItem
    |         |         |               +-column_ref=
    |         |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#13)
    |         |         +-input_scan=
    |         |           +-ProjectScan
    |         |             +-column_list=[$subquery1.array_input#11]
    |         |             +-expr_list=
    |         |             | +-array_input#11 :=
    |         |             |   +-SubqueryExpr
    |         |             |     +-type=ARRAY<INT64>
    |         |             |     +-subquery_type=SCALAR
    |         |             |     +-parameter_list=
    |         |             |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |             |     +-subquery=
    |         |             |       +-ProjectScan
    |         |             |         +-column_list=[$expr_subquery.$col1#10]
    |         |             |         +-expr_list=
    |         |             |         | +-$col1#10 :=
    |         |             |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |             |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |             |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#7)
    |         |             |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |             |         |     +-SubqueryExpr
    |         |             |         |       +-type=ARRAY<INT64>
    |         |             |         |       +-subquery_type=ARRAY
    |         |             |         |       +-parameter_list=
    |         |             |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#7)
    |         |             |         |       +-subquery=
    |         |             |         |         +-OrderByScan
    |         |             |         |           +-column_list=[$array.element#8]
    |         |             |         |           +-is_ordered=TRUE
    |         |             |         |           +-input_scan=
    |         |             |         |           | +-FilterScan
    |         |             |         |           |   +-column_list=[$array.element#8, $array_offset.off#9]
    |         |             |         |           |   +-input_scan=
    |         |             |         |           |   | +-ArrayScan
    |         |             |         |           |   |   +-column_list=[$array.element#8, $array_offset.off#9]
    |         |             |         |           |   |   +-array_expr=
    |         |             |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#7, is_correlated=TRUE)
    |         |             |         |           |   |   +-element_column=$array.element#8
    |         |             |         |           |   |   +-array_offset_column=
    |         |             |         |           |   |     +-ColumnHolder(column=$array_offset.off#9)
    |         |             |         |           |   +-filter_expr=
    |         |             |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |             |         |           |       +-ColumnRef(type=INT64, column=$array.element#8)
    |         |             |         |           |       +-Literal(type=INT64, value=0)
    |         |             |         |           +-order_by_item_list=
    |         |             |         |             +-OrderByItem
    |         |             |         |               +-column_ref=
    |         |             |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#9)
    |         |             |         +-input_scan=
    |         |             |           +-ProjectScan
    |         |             |             +-column_list=[$subquery1.array_input#7]
    |         |             |             +-expr_list=
    |         |             |             | +-array_input#7 :=
    |         |             |             |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |             |             |     +-Literal(type=INT64, value=1)
    |         |             |             |     +-Literal(type=INT64, value=2)
    |         |             |             |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |             |             +-input_scan=
    |         |             |               +-SingleRowScan
    |         |             +-input_scan=
    |         |               +-SingleRowScan
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# Lambda body has ARRAY_FILTER and column ref.
SELECT ARRAY_FILTER([1,2,3], e-> e > ARRAY_LENGTH(ARRAY_FILTER([1,2,Key], e->e<0))) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#3]
    |           +-parameter_list=
    |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |               +-FunctionCall(ZetaSQL:array_length(ARRAY<INT64>) -> INT64)
    |                 +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |                   +-FunctionArgument
    |                   | +-expr=
    |                   |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |                   |     +-Literal(type=INT64, value=1)
    |                   |     +-Literal(type=INT64, value=2)
    |                   |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |                   +-FunctionArgument
    |                     +-inline_lambda=
    |                       +-InlineLambda
    |                         +-argument_list=[$lambda_arg.e#4]
    |                         +-body=
    |                           +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |                             +-ColumnRef(type=INT64, column=$lambda_arg.e#4)
    |                             +-Literal(type=INT64, value=0)
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#13]
    |         +-expr_list=
    |         | +-$col1#13 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#10)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#10)
    |         |       | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#11]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#11, $array_offset.off#12]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#11, $array_offset.off#12]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#10, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#11
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#12)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#11)
    |         |           |       +-FunctionCall(ZetaSQL:array_length(ARRAY<INT64>) -> INT64)
    |         |           |         +-SubqueryExpr
    |         |           |           +-type=ARRAY<INT64>
    |         |           |           +-subquery_type=SCALAR
    |         |           |           +-parameter_list=
    |         |           |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           |           +-subquery=
    |         |           |             +-ProjectScan
    |         |           |               +-column_list=[$expr_subquery.$col1#9]
    |         |           |               +-expr_list=
    |         |           |               | +-$col1#9 :=
    |         |           |               |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |           |               |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |           |               |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |           |               |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |           |               |     +-SubqueryExpr
    |         |           |               |       +-type=ARRAY<INT64>
    |         |           |               |       +-subquery_type=ARRAY
    |         |           |               |       +-parameter_list=
    |         |           |               |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |           |               |       +-subquery=
    |         |           |               |         +-OrderByScan
    |         |           |               |           +-column_list=[$array.element#7]
    |         |           |               |           +-is_ordered=TRUE
    |         |           |               |           +-input_scan=
    |         |           |               |           | +-FilterScan
    |         |           |               |           |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |           |               |           |   +-input_scan=
    |         |           |               |           |   | +-ArrayScan
    |         |           |               |           |   |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |           |               |           |   |   +-array_expr=
    |         |           |               |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6, is_correlated=TRUE)
    |         |           |               |           |   |   +-element_column=$array.element#7
    |         |           |               |           |   |   +-array_offset_column=
    |         |           |               |           |   |     +-ColumnHolder(column=$array_offset.off#8)
    |         |           |               |           |   +-filter_expr=
    |         |           |               |           |     +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |         |           |               |           |       +-ColumnRef(type=INT64, column=$array.element#7)
    |         |           |               |           |       +-Literal(type=INT64, value=0)
    |         |           |               |           +-order_by_item_list=
    |         |           |               |             +-OrderByItem
    |         |           |               |               +-column_ref=
    |         |           |               |                 +-ColumnRef(type=INT64, column=$array_offset.off#8)
    |         |           |               +-input_scan=
    |         |           |                 +-ProjectScan
    |         |           |                   +-column_list=[$subquery1.array_input#6]
    |         |           |                   +-expr_list=
    |         |           |                   | +-array_input#6 :=
    |         |           |                   |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |           |                   |     +-Literal(type=INT64, value=1)
    |         |           |                   |     +-Literal(type=INT64, value=2)
    |         |           |                   |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           |                   +-input_scan=
    |         |           |                     +-SingleRowScan
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#12)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#10]
    |             +-expr_list=
    |             | +-array_input#10 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# Lambda body has ARRAY_FILTER and correlated column ref.
SELECT (SELECT ARRAY_FILTER([1,2,3], e-> e > ARRAY_LENGTH(ARRAY_FILTER([1,2,Key], e->e<0)))) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#6 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#6]
    +-expr_list=
    | +-$col1#6 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#5]
    |         +-expr_list=
    |         | +-$col1#5 :=
    |         |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |         |     +-FunctionArgument
    |         |     | +-expr=
    |         |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |         |     +-FunctionArgument
    |         |       +-inline_lambda=
    |         |         +-InlineLambda
    |         |           +-argument_list=[$lambda_arg.e#3]
    |         |           +-parameter_list=
    |         |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           +-body=
    |         |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |               +-ColumnRef(type=INT64, column=$lambda_arg.e#3)
    |         |               +-FunctionCall(ZetaSQL:array_length(ARRAY<INT64>) -> INT64)
    |         |                 +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |         |                   +-FunctionArgument
    |         |                   | +-expr=
    |         |                   |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |                   |     +-Literal(type=INT64, value=1)
    |         |                   |     +-Literal(type=INT64, value=2)
    |         |                   |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |                   +-FunctionArgument
    |         |                     +-inline_lambda=
    |         |                       +-InlineLambda
    |         |                         +-argument_list=[$lambda_arg.e#4]
    |         |                         +-body=
    |         |                           +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |         |                             +-ColumnRef(type=INT64, column=$lambda_arg.e#4)
    |         |                             +-Literal(type=INT64, value=0)
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#6 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#6]
    +-expr_list=
    | +-$col1#6 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#5]
    |         +-expr_list=
    |         | +-$col1#5 :=
    |         |   +-SubqueryExpr
    |         |     +-type=ARRAY<INT64>
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     +-subquery=
    |         |       +-ProjectScan
    |         |         +-column_list=[$expr_subquery.$col1#14]
    |         |         +-expr_list=
    |         |         | +-$col1#14 :=
    |         |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#11)
    |         |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |         |     +-SubqueryExpr
    |         |         |       +-type=ARRAY<INT64>
    |         |         |       +-subquery_type=ARRAY
    |         |         |       +-parameter_list=
    |         |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#11)
    |         |         |       | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |         |       +-subquery=
    |         |         |         +-OrderByScan
    |         |         |           +-column_list=[$array.element#12]
    |         |         |           +-is_ordered=TRUE
    |         |         |           +-input_scan=
    |         |         |           | +-FilterScan
    |         |         |           |   +-column_list=[$array.element#12, $array_offset.off#13]
    |         |         |           |   +-input_scan=
    |         |         |           |   | +-ArrayScan
    |         |         |           |   |   +-column_list=[$array.element#12, $array_offset.off#13]
    |         |         |           |   |   +-array_expr=
    |         |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#11, is_correlated=TRUE)
    |         |         |           |   |   +-element_column=$array.element#12
    |         |         |           |   |   +-array_offset_column=
    |         |         |           |   |     +-ColumnHolder(column=$array_offset.off#13)
    |         |         |           |   +-filter_expr=
    |         |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |         |           |       +-ColumnRef(type=INT64, column=$array.element#12)
    |         |         |           |       +-FunctionCall(ZetaSQL:array_length(ARRAY<INT64>) -> INT64)
    |         |         |           |         +-SubqueryExpr
    |         |         |           |           +-type=ARRAY<INT64>
    |         |         |           |           +-subquery_type=SCALAR
    |         |         |           |           +-parameter_list=
    |         |         |           |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |         |           |           +-subquery=
    |         |         |           |             +-ProjectScan
    |         |         |           |               +-column_list=[$expr_subquery.$col1#10]
    |         |         |           |               +-expr_list=
    |         |         |           |               | +-$col1#10 :=
    |         |         |           |               |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |         |           |               |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |         |           |               |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#7)
    |         |         |           |               |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |         |           |               |     +-SubqueryExpr
    |         |         |           |               |       +-type=ARRAY<INT64>
    |         |         |           |               |       +-subquery_type=ARRAY
    |         |         |           |               |       +-parameter_list=
    |         |         |           |               |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#7)
    |         |         |           |               |       +-subquery=
    |         |         |           |               |         +-OrderByScan
    |         |         |           |               |           +-column_list=[$array.element#8]
    |         |         |           |               |           +-is_ordered=TRUE
    |         |         |           |               |           +-input_scan=
    |         |         |           |               |           | +-FilterScan
    |         |         |           |               |           |   +-column_list=[$array.element#8, $array_offset.off#9]
    |         |         |           |               |           |   +-input_scan=
    |         |         |           |               |           |   | +-ArrayScan
    |         |         |           |               |           |   |   +-column_list=[$array.element#8, $array_offset.off#9]
    |         |         |           |               |           |   |   +-array_expr=
    |         |         |           |               |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#7, is_correlated=TRUE)
    |         |         |           |               |           |   |   +-element_column=$array.element#8
    |         |         |           |               |           |   |   +-array_offset_column=
    |         |         |           |               |           |   |     +-ColumnHolder(column=$array_offset.off#9)
    |         |         |           |               |           |   +-filter_expr=
    |         |         |           |               |           |     +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |         |         |           |               |           |       +-ColumnRef(type=INT64, column=$array.element#8)
    |         |         |           |               |           |       +-Literal(type=INT64, value=0)
    |         |         |           |               |           +-order_by_item_list=
    |         |         |           |               |             +-OrderByItem
    |         |         |           |               |               +-column_ref=
    |         |         |           |               |                 +-ColumnRef(type=INT64, column=$array_offset.off#9)
    |         |         |           |               +-input_scan=
    |         |         |           |                 +-ProjectScan
    |         |         |           |                   +-column_list=[$subquery1.array_input#7]
    |         |         |           |                   +-expr_list=
    |         |         |           |                   | +-array_input#7 :=
    |         |         |           |                   |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |         |           |                   |     +-Literal(type=INT64, value=1)
    |         |         |           |                   |     +-Literal(type=INT64, value=2)
    |         |         |           |                   |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |         |           |                   +-input_scan=
    |         |         |           |                     +-SingleRowScan
    |         |         |           +-order_by_item_list=
    |         |         |             +-OrderByItem
    |         |         |               +-column_ref=
    |         |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#13)
    |         |         +-input_scan=
    |         |           +-ProjectScan
    |         |             +-column_list=[$subquery1.array_input#11]
    |         |             +-expr_list=
    |         |             | +-array_input#11 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |         |             +-input_scan=
    |         |               +-SingleRowScan
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# Lambda arg has with same name as a potential correlated column.
# The lambda arg shadows the correlated column.
SELECT (SELECT(ARRAY_FILTER([1,2,Key], Key->Key>1))) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#4]
    |         +-expr_list=
    |         | +-$col1#4 :=
    |         |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |         |     +-FunctionArgument
    |         |     | +-expr=
    |         |     |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |     |     +-Literal(type=INT64, value=1)
    |         |     |     +-Literal(type=INT64, value=2)
    |         |     |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     +-FunctionArgument
    |         |       +-inline_lambda=
    |         |         +-InlineLambda
    |         |           +-argument_list=[$lambda_arg.Key#3]
    |         |           +-body=
    |         |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |               +-ColumnRef(type=INT64, column=$lambda_arg.Key#3)
    |         |               +-Literal(type=INT64, value=1)
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#4]
    |         +-expr_list=
    |         | +-$col1#4 :=
    |         |   +-SubqueryExpr
    |         |     +-type=ARRAY<INT64>
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     +-subquery=
    |         |       +-ProjectScan
    |         |         +-column_list=[$expr_subquery.$col1#9]
    |         |         +-expr_list=
    |         |         | +-$col1#9 :=
    |         |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |         |     +-SubqueryExpr
    |         |         |       +-type=ARRAY<INT64>
    |         |         |       +-subquery_type=ARRAY
    |         |         |       +-parameter_list=
    |         |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |         |       +-subquery=
    |         |         |         +-OrderByScan
    |         |         |           +-column_list=[$array.element#7]
    |         |         |           +-is_ordered=TRUE
    |         |         |           +-input_scan=
    |         |         |           | +-FilterScan
    |         |         |           |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |         |           |   +-input_scan=
    |         |         |           |   | +-ArrayScan
    |         |         |           |   |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |         |           |   |   +-array_expr=
    |         |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6, is_correlated=TRUE)
    |         |         |           |   |   +-element_column=$array.element#7
    |         |         |           |   |   +-array_offset_column=
    |         |         |           |   |     +-ColumnHolder(column=$array_offset.off#8)
    |         |         |           |   +-filter_expr=
    |         |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |         |           |       +-ColumnRef(type=INT64, column=$array.element#7)
    |         |         |           |       +-Literal(type=INT64, value=1)
    |         |         |           +-order_by_item_list=
    |         |         |             +-OrderByItem
    |         |         |               +-column_ref=
    |         |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#8)
    |         |         +-input_scan=
    |         |           +-ProjectScan
    |         |             +-column_list=[$subquery1.array_input#6]
    |         |             +-expr_list=
    |         |             | +-array_input#6 :=
    |         |             |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |             |     +-Literal(type=INT64, value=1)
    |         |             |     +-Literal(type=INT64, value=2)
    |         |             |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |             +-input_scan=
    |         |               +-SingleRowScan
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# Lambda arg has with same name as a potential correlated column. Lambda body
# has a mix of lambda arg and correlated column.
SELECT (SELECT(ARRAY_FILTER([1,2,Key], Key->kv.Key>Key))) FROM KeyValue as kv;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#4]
    |         +-expr_list=
    |         | +-$col1#4 :=
    |         |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |         |     +-FunctionArgument
    |         |     | +-expr=
    |         |     |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |     |     +-Literal(type=INT64, value=1)
    |         |     |     +-Literal(type=INT64, value=2)
    |         |     |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     +-FunctionArgument
    |         |       +-inline_lambda=
    |         |         +-InlineLambda
    |         |           +-argument_list=[$lambda_arg.Key#3]
    |         |           +-parameter_list=
    |         |           | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |           +-body=
    |         |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |               +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |               +-ColumnRef(type=INT64, column=$lambda_arg.Key#3)
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#5 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#5]
    +-expr_list=
    | +-$col1#5 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-parameter_list=
    |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1)
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#4]
    |         +-expr_list=
    |         | +-$col1#4 :=
    |         |   +-SubqueryExpr
    |         |     +-type=ARRAY<INT64>
    |         |     +-subquery_type=SCALAR
    |         |     +-parameter_list=
    |         |     | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |     +-subquery=
    |         |       +-ProjectScan
    |         |         +-column_list=[$expr_subquery.$col1#9]
    |         |         +-expr_list=
    |         |         | +-$col1#9 :=
    |         |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |         |     +-SubqueryExpr
    |         |         |       +-type=ARRAY<INT64>
    |         |         |       +-subquery_type=ARRAY
    |         |         |       +-parameter_list=
    |         |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6)
    |         |         |       | +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |         |       +-subquery=
    |         |         |         +-OrderByScan
    |         |         |           +-column_list=[$array.element#7]
    |         |         |           +-is_ordered=TRUE
    |         |         |           +-input_scan=
    |         |         |           | +-FilterScan
    |         |         |           |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |         |           |   +-input_scan=
    |         |         |           |   | +-ArrayScan
    |         |         |           |   |   +-column_list=[$array.element#7, $array_offset.off#8]
    |         |         |           |   |   +-array_expr=
    |         |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#6, is_correlated=TRUE)
    |         |         |           |   |   +-element_column=$array.element#7
    |         |         |           |   |   +-array_offset_column=
    |         |         |           |   |     +-ColumnHolder(column=$array_offset.off#8)
    |         |         |           |   +-filter_expr=
    |         |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |         |           |       +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |         |           |       +-ColumnRef(type=INT64, column=$array.element#7)
    |         |         |           +-order_by_item_list=
    |         |         |             +-OrderByItem
    |         |         |               +-column_ref=
    |         |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#8)
    |         |         +-input_scan=
    |         |           +-ProjectScan
    |         |             +-column_list=[$subquery1.array_input#6]
    |         |             +-expr_list=
    |         |             | +-array_input#6 :=
    |         |             |   +-FunctionCall(ZetaSQL:$make_array(repeated(3) INT64) -> ARRAY<INT64>)
    |         |             |     +-Literal(type=INT64, value=1)
    |         |             |     +-Literal(type=INT64, value=2)
    |         |             |     +-ColumnRef(type=INT64, column=KeyValue.Key#1, is_correlated=TRUE)
    |         |             +-input_scan=
    |         |               +-SingleRowScan
    |         +-input_scan=
    |           +-SingleRowScan
    +-input_scan=
      +-TableScan(column_list=[KeyValue.Key#1], table=KeyValue, column_index_list=[0], alias="kv")
==

# ARRAY_TRANSFORM as input to ARRAY_FILTER.
SELECT ARRAY_FILTER(ARRAY_TRANSFORM([1,2,3], e->e+1), e -> e>0);
--
QueryStmt
+-output_column_list=
| +-$query.$col1#3 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#3]
    +-expr_list=
    | +-$col1#3 :=
    |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-FunctionCall(ZetaSQL:array_transform(ARRAY<INT64>, LAMBDA(INT64->INT64)) -> ARRAY<INT64>)
    |     |     +-FunctionArgument
    |     |     | +-expr=
    |     |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     |     +-FunctionArgument
    |     |       +-inline_lambda=
    |     |         +-InlineLambda
    |     |           +-argument_list=[$lambda_arg.e#1]
    |     |           +-body=
    |     |             +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |     |               +-ColumnRef(type=INT64, column=$lambda_arg.e#1)
    |     |               +-Literal(type=INT64, value=1)
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#2]
    |           +-body=
    |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |               +-ColumnRef(type=INT64, column=$lambda_arg.e#2)
    |               +-Literal(type=INT64, value=0)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#3 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#3]
    +-expr_list=
    | +-$col1#3 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#12]
    |         +-expr_list=
    |         | +-$col1#12 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#9)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#9)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$array.element#10]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-FilterScan
    |         |           |   +-column_list=[$array.element#10, $array_offset.off#11]
    |         |           |   +-input_scan=
    |         |           |   | +-ArrayScan
    |         |           |   |   +-column_list=[$array.element#10, $array_offset.off#11]
    |         |           |   |   +-array_expr=
    |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#9, is_correlated=TRUE)
    |         |           |   |   +-element_column=$array.element#10
    |         |           |   |   +-array_offset_column=
    |         |           |   |     +-ColumnHolder(column=$array_offset.off#11)
    |         |           |   +-filter_expr=
    |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |       +-ColumnRef(type=INT64, column=$array.element#10)
    |         |           |       +-Literal(type=INT64, value=0)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#11)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#9]
    |             +-expr_list=
    |             | +-array_input#9 :=
    |             |   +-SubqueryExpr
    |             |     +-type=ARRAY<INT64>
    |             |     +-subquery_type=SCALAR
    |             |     +-subquery=
    |             |       +-ProjectScan
    |             |         +-column_list=[$expr_subquery.$col1#8]
    |             |         +-expr_list=
    |             |         | +-$col1#8 :=
    |             |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |             |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |             |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4)
    |             |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |             |         |     +-SubqueryExpr
    |             |         |       +-type=ARRAY<INT64>
    |             |         |       +-subquery_type=ARRAY
    |             |         |       +-parameter_list=
    |             |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4)
    |             |         |       +-subquery=
    |             |         |         +-OrderByScan
    |             |         |           +-column_list=[$expr_subquery.$col1#7]
    |             |         |           +-is_ordered=TRUE
    |             |         |           +-input_scan=
    |             |         |           | +-ProjectScan
    |             |         |           |   +-column_list=[$array.element#5, $array_offset.off#6, $expr_subquery.$col1#7]
    |             |         |           |   +-expr_list=
    |             |         |           |   | +-$col1#7 :=
    |             |         |           |   |   +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |             |         |           |   |     +-ColumnRef(type=INT64, column=$array.element#5)
    |             |         |           |   |     +-Literal(type=INT64, value=1)
    |             |         |           |   +-input_scan=
    |             |         |           |     +-ArrayScan
    |             |         |           |       +-column_list=[$array.element#5, $array_offset.off#6]
    |             |         |           |       +-array_expr=
    |             |         |           |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4, is_correlated=TRUE)
    |             |         |           |       +-element_column=$array.element#5
    |             |         |           |       +-array_offset_column=
    |             |         |           |         +-ColumnHolder(column=$array_offset.off#6)
    |             |         |           +-order_by_item_list=
    |             |         |             +-OrderByItem
    |             |         |               +-column_ref=
    |             |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#6)
    |             |         +-input_scan=
    |             |           +-ProjectScan
    |             |             +-column_list=[$subquery1.array_input#4]
    |             |             +-expr_list=
    |             |             | +-array_input#4 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             |             +-input_scan=
    |             |               +-SingleRowScan
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

# ARRAY_FILTER inside lambda of ARRAY_TRANSFORM.
SELECT ARRAY_TRANSFORM([1,2,3], e -> ARRAY_LENGTH(ARRAY_FILTER([e, 4], e->e>1)));
--
QueryStmt
+-output_column_list=
| +-$query.$col1#3 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#3]
    +-expr_list=
    | +-$col1#3 :=
    |   +-FunctionCall(ZetaSQL:array_transform(ARRAY<INT64>, LAMBDA(INT64->INT64)) -> ARRAY<INT64>)
    |     +-FunctionArgument
    |     | +-expr=
    |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |     +-FunctionArgument
    |       +-inline_lambda=
    |         +-InlineLambda
    |           +-argument_list=[$lambda_arg.e#1]
    |           +-body=
    |             +-FunctionCall(ZetaSQL:array_length(ARRAY<INT64>) -> INT64)
    |               +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |                 +-FunctionArgument
    |                 | +-expr=
    |                 |   +-FunctionCall(ZetaSQL:$make_array(repeated(2) INT64) -> ARRAY<INT64>)
    |                 |     +-ColumnRef(type=INT64, column=$lambda_arg.e#1)
    |                 |     +-Literal(type=INT64, value=4)
    |                 +-FunctionArgument
    |                   +-inline_lambda=
    |                     +-InlineLambda
    |                       +-argument_list=[$lambda_arg.e#2]
    |                       +-body=
    |                         +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |                           +-ColumnRef(type=INT64, column=$lambda_arg.e#2)
    |                           +-Literal(type=INT64, value=1)
    +-input_scan=
      +-SingleRowScan

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#3 AS `$col1` [ARRAY<INT64>]
+-query=
  +-ProjectScan
    +-column_list=[$query.$col1#3]
    +-expr_list=
    | +-$col1#3 :=
    |   +-SubqueryExpr
    |     +-type=ARRAY<INT64>
    |     +-subquery_type=SCALAR
    |     +-subquery=
    |       +-ProjectScan
    |         +-column_list=[$expr_subquery.$col1#12]
    |         +-expr_list=
    |         | +-$col1#12 :=
    |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#8)
    |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |     +-SubqueryExpr
    |         |       +-type=ARRAY<INT64>
    |         |       +-subquery_type=ARRAY
    |         |       +-parameter_list=
    |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#8)
    |         |       +-subquery=
    |         |         +-OrderByScan
    |         |           +-column_list=[$expr_subquery.$col1#11]
    |         |           +-is_ordered=TRUE
    |         |           +-input_scan=
    |         |           | +-ProjectScan
    |         |           |   +-column_list=[$array.element#9, $array_offset.off#10, $expr_subquery.$col1#11]
    |         |           |   +-expr_list=
    |         |           |   | +-$col1#11 :=
    |         |           |   |   +-FunctionCall(ZetaSQL:array_length(ARRAY<INT64>) -> INT64)
    |         |           |   |     +-SubqueryExpr
    |         |           |   |       +-type=ARRAY<INT64>
    |         |           |   |       +-subquery_type=SCALAR
    |         |           |   |       +-parameter_list=
    |         |           |   |       | +-ColumnRef(type=INT64, column=$array.element#9)
    |         |           |   |       +-subquery=
    |         |           |   |         +-ProjectScan
    |         |           |   |           +-column_list=[$expr_subquery.$col1#7]
    |         |           |   |           +-expr_list=
    |         |           |   |           | +-$col1#7 :=
    |         |           |   |           |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |         |           |   |           |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |         |           |   |           |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4)
    |         |           |   |           |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |         |           |   |           |     +-SubqueryExpr
    |         |           |   |           |       +-type=ARRAY<INT64>
    |         |           |   |           |       +-subquery_type=ARRAY
    |         |           |   |           |       +-parameter_list=
    |         |           |   |           |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4)
    |         |           |   |           |       +-subquery=
    |         |           |   |           |         +-OrderByScan
    |         |           |   |           |           +-column_list=[$array.element#5]
    |         |           |   |           |           +-is_ordered=TRUE
    |         |           |   |           |           +-input_scan=
    |         |           |   |           |           | +-FilterScan
    |         |           |   |           |           |   +-column_list=[$array.element#5, $array_offset.off#6]
    |         |           |   |           |           |   +-input_scan=
    |         |           |   |           |           |   | +-ArrayScan
    |         |           |   |           |           |   |   +-column_list=[$array.element#5, $array_offset.off#6]
    |         |           |   |           |           |   |   +-array_expr=
    |         |           |   |           |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#4, is_correlated=TRUE)
    |         |           |   |           |           |   |   +-element_column=$array.element#5
    |         |           |   |           |           |   |   +-array_offset_column=
    |         |           |   |           |           |   |     +-ColumnHolder(column=$array_offset.off#6)
    |         |           |   |           |           |   +-filter_expr=
    |         |           |   |           |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |         |           |   |           |           |       +-ColumnRef(type=INT64, column=$array.element#5)
    |         |           |   |           |           |       +-Literal(type=INT64, value=1)
    |         |           |   |           |           +-order_by_item_list=
    |         |           |   |           |             +-OrderByItem
    |         |           |   |           |               +-column_ref=
    |         |           |   |           |                 +-ColumnRef(type=INT64, column=$array_offset.off#6)
    |         |           |   |           +-input_scan=
    |         |           |   |             +-ProjectScan
    |         |           |   |               +-column_list=[$subquery1.array_input#4]
    |         |           |   |               +-expr_list=
    |         |           |   |               | +-array_input#4 :=
    |         |           |   |               |   +-FunctionCall(ZetaSQL:$make_array(repeated(2) INT64) -> ARRAY<INT64>)
    |         |           |   |               |     +-ColumnRef(type=INT64, column=$array.element#9, is_correlated=TRUE)
    |         |           |   |               |     +-Literal(type=INT64, value=4)
    |         |           |   |               +-input_scan=
    |         |           |   |                 +-SingleRowScan
    |         |           |   +-input_scan=
    |         |           |     +-ArrayScan
    |         |           |       +-column_list=[$array.element#9, $array_offset.off#10]
    |         |           |       +-array_expr=
    |         |           |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#8, is_correlated=TRUE)
    |         |           |       +-element_column=$array.element#9
    |         |           |       +-array_offset_column=
    |         |           |         +-ColumnHolder(column=$array_offset.off#10)
    |         |           +-order_by_item_list=
    |         |             +-OrderByItem
    |         |               +-column_ref=
    |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#10)
    |         +-input_scan=
    |           +-ProjectScan
    |             +-column_list=[$subquery1.array_input#8]
    |             +-expr_list=
    |             | +-array_input#8 := Literal(type=ARRAY<INT64>, value=[1, 2, 3])
    |             +-input_scan=
    |               +-SingleRowScan
    +-input_scan=
      +-SingleRowScan
==

WITH RECURSIVE
  t1 AS (SELECT 1 AS n UNION ALL SELECT n + 1 FROM t1 WHERE n < 20)
SELECT ARRAY_FILTER([1,2], e->e>1) FROM t1;
--
QueryStmt
+-output_column_list=
| +-$query.$col1#7 AS `$col1` [ARRAY<INT64>]
+-query=
  +-WithScan
    +-column_list=[$query.$col1#7]
    +-with_entry_list=
    | +-WithEntry
    |   +-with_query_name="t1"
    |   +-with_subquery=
    |     +-RecursiveScan
    |       +-column_list=[$union_all.n#2]
    |       +-op_type=UNION_ALL
    |       +-non_recursive_term=
    |       | +-SetOperationItem
    |       |   +-scan=
    |       |   | +-ProjectScan
    |       |   |   +-column_list=[$union_all1.n#1]
    |       |   |   +-expr_list=
    |       |   |   | +-n#1 := Literal(type=INT64, value=1)
    |       |   |   +-input_scan=
    |       |   |     +-SingleRowScan
    |       |   +-output_column_list=[$union_all1.n#1]
    |       +-recursive_term=
    |         +-SetOperationItem
    |           +-scan=
    |           | +-ProjectScan
    |           |   +-column_list=[$union_all2.$col1#4]
    |           |   +-expr_list=
    |           |   | +-$col1#4 :=
    |           |   |   +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |           |   |     +-ColumnRef(type=INT64, column=t1.n#3)
    |           |   |     +-Literal(type=INT64, value=1)
    |           |   +-input_scan=
    |           |     +-FilterScan
    |           |       +-column_list=[t1.n#3]
    |           |       +-input_scan=
    |           |       | +-RecursiveRefScan(column_list=[t1.n#3])
    |           |       +-filter_expr=
    |           |         +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |           |           +-ColumnRef(type=INT64, column=t1.n#3)
    |           |           +-Literal(type=INT64, value=20)
    |           +-output_column_list=[$union_all2.$col1#4]
    +-query=
    | +-ProjectScan
    |   +-column_list=[$query.$col1#7]
    |   +-expr_list=
    |   | +-$col1#7 :=
    |   |   +-FunctionCall(ZetaSQL:array_filter(ARRAY<INT64>, LAMBDA(INT64->BOOL)) -> ARRAY<INT64>)
    |   |     +-FunctionArgument
    |   |     | +-expr=
    |   |     |   +-Literal(type=ARRAY<INT64>, value=[1, 2])
    |   |     +-FunctionArgument
    |   |       +-inline_lambda=
    |   |         +-InlineLambda
    |   |           +-argument_list=[$lambda_arg.e#6]
    |   |           +-body=
    |   |             +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |   |               +-ColumnRef(type=INT64, column=$lambda_arg.e#6)
    |   |               +-Literal(type=INT64, value=1)
    |   +-input_scan=
    |     +-WithRefScan(column_list=[t1.n#5], with_query_name="t1")
    +-recursive=TRUE

[REWRITTEN AST]
QueryStmt
+-output_column_list=
| +-$query.$col1#7 AS `$col1` [ARRAY<INT64>]
+-query=
  +-WithScan
    +-column_list=[$query.$col1#7]
    +-with_entry_list=
    | +-WithEntry
    |   +-with_query_name="t1"
    |   +-with_subquery=
    |     +-RecursiveScan
    |       +-column_list=[$union_all.n#2]
    |       +-op_type=UNION_ALL
    |       +-non_recursive_term=
    |       | +-SetOperationItem
    |       |   +-scan=
    |       |   | +-ProjectScan
    |       |   |   +-column_list=[$union_all1.n#1]
    |       |   |   +-expr_list=
    |       |   |   | +-n#1 := Literal(type=INT64, value=1)
    |       |   |   +-input_scan=
    |       |   |     +-SingleRowScan
    |       |   +-output_column_list=[$union_all1.n#1]
    |       +-recursive_term=
    |         +-SetOperationItem
    |           +-scan=
    |           | +-ProjectScan
    |           |   +-column_list=[$union_all2.$col1#4]
    |           |   +-expr_list=
    |           |   | +-$col1#4 :=
    |           |   |   +-FunctionCall(ZetaSQL:$add(INT64, INT64) -> INT64)
    |           |   |     +-ColumnRef(type=INT64, column=t1.n#3)
    |           |   |     +-Literal(type=INT64, value=1)
    |           |   +-input_scan=
    |           |     +-FilterScan
    |           |       +-column_list=[t1.n#3]
    |           |       +-input_scan=
    |           |       | +-RecursiveRefScan(column_list=[t1.n#3])
    |           |       +-filter_expr=
    |           |         +-FunctionCall(ZetaSQL:$less(INT64, INT64) -> BOOL)
    |           |           +-ColumnRef(type=INT64, column=t1.n#3)
    |           |           +-Literal(type=INT64, value=20)
    |           +-output_column_list=[$union_all2.$col1#4]
    +-query=
    | +-ProjectScan
    |   +-column_list=[$query.$col1#7]
    |   +-expr_list=
    |   | +-$col1#7 :=
    |   |   +-SubqueryExpr
    |   |     +-type=ARRAY<INT64>
    |   |     +-subquery_type=SCALAR
    |   |     +-subquery=
    |   |       +-ProjectScan
    |   |         +-column_list=[$expr_subquery.$col1#11]
    |   |         +-expr_list=
    |   |         | +-$col1#11 :=
    |   |         |   +-FunctionCall(ZetaSQL:if(BOOL, ARRAY<INT64>, ARRAY<INT64>) -> ARRAY<INT64>)
    |   |         |     +-FunctionCall(ZetaSQL:$is_null(ARRAY<INT64>) -> BOOL)
    |   |         |     | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#8)
    |   |         |     +-Literal(type=ARRAY<INT64>, value=NULL)
    |   |         |     +-SubqueryExpr
    |   |         |       +-type=ARRAY<INT64>
    |   |         |       +-subquery_type=ARRAY
    |   |         |       +-parameter_list=
    |   |         |       | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#8)
    |   |         |       +-subquery=
    |   |         |         +-OrderByScan
    |   |         |           +-column_list=[$array.element#9]
    |   |         |           +-is_ordered=TRUE
    |   |         |           +-input_scan=
    |   |         |           | +-FilterScan
    |   |         |           |   +-column_list=[$array.element#9, $array_offset.off#10]
    |   |         |           |   +-input_scan=
    |   |         |           |   | +-ArrayScan
    |   |         |           |   |   +-column_list=[$array.element#9, $array_offset.off#10]
    |   |         |           |   |   +-array_expr=
    |   |         |           |   |   | +-ColumnRef(type=ARRAY<INT64>, column=$subquery1.array_input#8, is_correlated=TRUE)
    |   |         |           |   |   +-element_column=$array.element#9
    |   |         |           |   |   +-array_offset_column=
    |   |         |           |   |     +-ColumnHolder(column=$array_offset.off#10)
    |   |         |           |   +-filter_expr=
    |   |         |           |     +-FunctionCall(ZetaSQL:$greater(INT64, INT64) -> BOOL)
    |   |         |           |       +-ColumnRef(type=INT64, column=$array.element#9)
    |   |         |           |       +-Literal(type=INT64, value=1)
    |   |         |           +-order_by_item_list=
    |   |         |             +-OrderByItem
    |   |         |               +-column_ref=
    |   |         |                 +-ColumnRef(type=INT64, column=$array_offset.off#10)
    |   |         +-input_scan=
    |   |           +-ProjectScan
    |   |             +-column_list=[$subquery1.array_input#8]
    |   |             +-expr_list=
    |   |             | +-array_input#8 := Literal(type=ARRAY<INT64>, value=[1, 2])
    |   |             +-input_scan=
    |   |               +-SingleRowScan
    |   +-input_scan=
    |     +-WithRefScan(column_list=[t1.n#5], with_query_name="t1")
    +-recursive=TRUE
==

SELECT SAFE.ARRAY_FILTER([1,2,3], e -> e>0);
--
ERROR: Function calls with SAFE are not supported [at 1:8]
SELECT SAFE.ARRAY_FILTER([1,2,3], e -> e>0);
       ^
